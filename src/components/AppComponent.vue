
<template>
  <main>
    <svg
      width="342"
      height="67"
      viewBox="0 0 342 67"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        d="M1.33019 6.99997L330.442 2.19426L333.999 48.5L1.3303 58.5L1.33019 6.99997Z"
        fill="#F58CC1"
      />
      <rect
        x="2.49805"
        y="5.9538"
        width="330"
        height="48"
        transform="rotate(-1 2.49805 5.9538)"
        fill="#EA1589"
      />
      <path
        d="M18.4475 37.0931C19.326 43.4147 23.1264 46.6129 29.6534 46.4989C33.0129 46.4403 35.8765 45.4782 37.6709 43.7666C39.5596 41.9574 40.8473 38.7184 40.7954 35.7428C40.73 31.9994 38.8653 29.6796 34.0233 27.3158C30.5376 25.6483 30.5376 25.6483 30.0518 25.3208C28.693 24.4803 28.1988 23.6728 28.1753 22.3291C28.1418 20.4093 29.5582 19.0404 31.4779 19.0069C33.4936 18.9717 34.4238 20.0116 35.151 23.1674L41.5999 21.3266C40.3063 15.9724 36.8973 13.1994 31.5701 13.2924C28.3546 13.3486 25.7815 14.4496 23.9929 16.4972C22.2987 18.447 21.2906 21.201 21.3367 23.8406C21.4062 27.824 23.4621 30.0925 29.317 32.7267C32.8001 34.2502 33.6319 35.1478 33.6679 37.2115C33.7056 39.3711 32.2413 40.7409 29.7457 40.7845C27.0581 40.8314 25.7877 39.5573 24.9056 35.7802L18.4475 37.0931ZM57.8165 12.8343C53.9291 12.9022 50.364 14.9327 48.167 18.3315C45.6424 22.2162 44.2063 27.9541 44.306 33.6653C44.4493 41.872 48.1258 46.2245 54.7968 46.1081C59.1161 46.0327 62.112 44.3961 64.4008 40.7556C66.9717 36.7742 68.2722 31.5187 68.1683 25.5676C68.0913 21.1522 67.0728 17.8095 65.261 15.7768C63.5478 13.8864 60.7921 12.7824 57.8165 12.8343ZM57.5803 18.5513C59.8359 18.5119 61.2157 20.5521 61.2769 24.0556C61.3406 27.7031 60.6085 32.5166 59.378 36.2826C58.513 38.9861 57.0967 40.3551 55.033 40.3911C52.6814 40.4321 51.2553 38.4887 51.1983 35.2252C51.1221 30.8579 52.0394 25.6571 53.5595 21.982C54.4337 19.8064 55.8525 18.5814 57.5803 18.5513ZM70.1207 45.2165L76.8396 45.0992L78.7748 32.1995L88.4213 32.0311L89.2832 26.3992L79.5887 26.5684L80.7942 18.6262L92.0725 18.4293L92.9344 12.7974L74.9371 13.1115L70.1207 45.2165ZM91.3987 44.8451L98.1177 44.7278L102.886 12.6237L96.2151 12.7401L91.3987 44.8451ZM121.646 12.2962L114.591 12.4194L101.04 44.6768L107.327 44.5671L110.13 37.413L118.193 37.2723L118.893 44.3652L125.804 44.2445L121.646 12.2962ZM116.684 19.5839L117.666 31.8567L112.147 31.953L116.684 19.5839ZM137.095 44.0475L143.814 43.9302L148.582 11.8261L141.911 11.9425L137.095 44.0475ZM149.327 43.8339L154.943 43.7359L158.234 20.5389L165.549 43.5508L170.732 43.4603L175.549 11.3554L169.933 11.4534L167.156 31.0888L160.911 11.6109L154.144 11.729L149.327 43.8339ZM184.735 34.1905C185.613 40.5122 189.414 43.7103 195.941 43.5964C199.3 43.5377 202.164 42.5756 203.958 40.864C205.847 39.0548 207.134 35.8158 207.083 32.8403C207.017 29.0969 205.152 26.7771 200.31 24.4132C196.825 22.7458 196.825 22.7458 196.339 22.4182C194.98 21.5778 194.486 20.7703 194.463 19.4265C194.429 17.5068 195.845 16.1379 197.765 16.1044C199.781 16.0692 200.711 17.1091 201.438 20.2649L207.887 18.4241C206.593 13.0698 203.185 10.2969 197.857 10.3899C194.642 10.446 192.069 11.5471 190.28 13.5946C188.586 15.5445 187.578 18.2985 187.624 20.9381C187.693 24.9215 189.749 27.1899 195.604 29.8242C199.087 31.3476 199.919 32.2452 199.955 34.3089C199.993 36.4686 198.528 37.8383 196.033 37.8819C193.345 37.9288 192.075 36.6548 191.193 32.8776L184.735 34.1905ZM224.104 9.93174C220.216 9.9996 216.651 12.0301 214.454 15.429C211.93 19.3136 210.494 25.0516 210.593 30.7627C210.736 38.9695 214.413 43.322 221.084 43.2055C225.403 43.1301 228.399 41.4936 230.688 37.8531C233.259 33.8716 234.559 28.6161 234.456 22.665C234.378 18.2497 233.36 14.907 231.548 12.8743C229.835 10.9839 227.079 9.8798 224.104 9.93174ZM223.867 15.6487C226.123 15.6094 227.503 17.6496 227.564 21.1531C227.628 24.8005 226.896 29.614 225.665 33.3801C224.8 36.0836 223.384 37.4525 221.32 37.4885C218.969 37.5296 217.542 35.5862 217.485 32.3227C217.409 27.9553 218.327 22.7545 219.847 19.0794C220.721 16.9038 222.14 15.6789 223.867 15.6487ZM240.888 10.2149L238.093 28.8425C237.793 30.912 237.634 32.7871 237.661 34.3229C237.756 39.794 241.313 42.8044 247.504 42.6963C251.296 42.6302 254.585 41.3245 256.182 39.2804C257.544 37.5763 258.365 35.0656 259.008 30.6377L262.149 9.84374L256.006 9.95097L253.084 29.589C252.784 31.6585 252.476 33.2481 252.158 34.2618C251.564 36.0005 250.284 36.9349 248.268 36.9701C245.821 37.0129 244.406 35.6934 244.364 33.2937C244.346 32.2859 244.384 31.7091 244.895 28.0036L247.559 10.0984L240.888 10.2149ZM262.56 41.8574L268.175 41.7594L271.467 18.5625L278.782 41.5743L283.965 41.4838L288.781 9.37888L283.166 9.47689L280.388 29.1124L274.144 9.63438L267.377 9.7525L262.56 41.8574ZM289.509 41.3871L297.908 41.2405C303.283 41.1466 305.482 40.6282 307.949 38.9529C312.314 35.9482 314.845 29.7111 314.714 22.1762C314.626 17.137 313.41 13.5097 311.119 11.4854C309.266 9.88544 305.94 9.07937 301.237 9.16147L294.326 9.2821L289.509 41.3871ZM296.999 35.9275L300.18 14.6527L301.476 14.6301C305.891 14.5531 307.212 15.9702 307.298 20.8655C307.381 25.6647 306.356 30.1473 304.485 33.0124C303.271 34.9539 301.462 35.8496 298.871 35.8948L296.999 35.9275Z"
        fill="white"
      />
    </svg>

    <section class="flex">
      <movie-frame
        :full-image="movieFrames[activeMovie].full"
        :placeholder-image="movieFrames[activeMovie].placeholder"
        :height="movieFrames[activeMovie].height"
        :seconds="movieFrameSeconds"
      />
      <div class="desc-container">
        <p class="desc">Bangers bangers bangers</p>
        <div class="hint">
          <svg
            role="img"
            width="32"
            height="36"
            viewBox="0 0 32 36"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M20.1493 31.9216C20.7252 32.3249 21.5366 32.1819 21.9399 31.6059C22.3432 31.0299 22.2001 30.2186 21.6242 29.8153C21.0482 29.412 20.2368 29.555 19.8335 30.131C19.4302 30.707 19.5733 31.5184 20.1493 31.9216ZM6.10182 25.2247C9.29432 27.4601 13.5832 27.3241 16.4631 29.3406L16.9897 29.7093L24.3642 19.1773L23.8376 18.8086C22.0933 17.5872 21.9619 15.288 21.7499 13.3493C21.6052 12.1198 21.5099 10.925 21.5776 9.67257C21.6056 9.17719 21.6617 8.67688 21.7177 8.17657C21.8017 7.67133 22.2991 5.17475 21.8383 4.85212C20.4395 3.87268 18.8366 3.53508 17.7304 5.11487C16.2555 7.22126 17.0863 9.3971 16.3604 10.4338L6.88162 3.79674C5.77905 3.02471 4.08386 3.3092 3.30031 4.42822C2.50525 5.56369 2.79632 7.21445 3.93179 8.00952L9.37879 11.8235C8.75666 11.9765 7.98471 12.5886 7.61598 13.1152C7.07441 13.8887 6.92617 14.7659 7.11695 15.6842C6.6775 15.8915 6.30222 16.2173 6.02567 16.6123C5.49563 17.3693 5.21732 18.5723 5.64346 19.4348C5.38668 19.6964 5.13484 19.986 4.9159 20.2987C3.52165 22.2899 4.24228 23.9226 6.10182 25.2247ZM4.54463 27.2734C1.50024 25.1417 0.656416 21.8287 2.86713 18.7415C2.80147 17.4693 3.19335 16.1741 3.9308 15.1209C4.09212 14.8905 4.28142 14.6552 4.47565 14.4479C4.55641 13.597 4.80339 12.789 5.23798 12.0633L2.45688 10.1159C0.15302 8.50273 -0.407739 5.24071 1.20545 2.93685C2.79558 0.665896 6.08557 0.100207 8.35653 1.69035L14.5111 5.99985C14.7367 5.15231 15.117 4.36403 15.624 3.63996C17.5714 0.858864 20.6967 0.913611 23.3132 2.74573C25.5183 4.28977 24.2556 7.59926 24.1384 9.798C24.0905 10.9171 24.1776 11.9836 24.2976 13.0731C24.3946 13.9503 24.5226 16.1491 25.3125 16.7022L30.0519 20.0208C31.2203 20.8389 31.5015 22.4337 30.6834 23.6021L23.3088 34.134C22.4907 35.3024 20.8959 35.5836 19.7275 34.7655L14.9882 31.4469C13.9514 30.721 11.8959 30.1891 10.6386 29.8483C8.48928 29.2753 6.38772 28.564 4.54463 27.2734Z"
              fill="#EA1589"
              fill-opacity="0.5"
            />
          </svg>
          <p>Thumb through the movies below to explore their soundtracks.</p>
        </div>
      </div>
    </section>

    <scene-scrubber
      v-for="(movie, name) in movieFrames"
      :key="name"
      :selected="activeMovie == movie.id"
      :activeSong="song.data"
      :setSeconds="setSeconds"
      :setSong="setSong"
      :hoverTag="hoverTag"
      :longestFilmLength="longestFilmLength"
      :displayMode="displayMode"
      :displayWidth="displayWidth"
      :duration="movie.seconds"
      :id="movie.id"
      :label="movie.label"
      :songsList="movieSongs[name]"
    />

    <song-footer
      :setIsPlaying="setIsPlaying"
      :isPlaying="song.playing"
      :song="song.data"
      :setTag="setTag"
    />
  </main>
</template>
<script>
import {
  MOVIES as movieFrames,
  DISPLAY_SIZES,
  SONGS as movieSongs
} from "../js/constants.js";

import MovieFrame from "./MovieFrame.vue";
import SceneScrubber from "./SceneScrubber.vue";
import SongFooter from "./SongFooter.vue";

export default {
  name: "App",
  components: {
    MovieFrame,
    SceneScrubber,
    SongFooter
  },
  data() {
    return {
      movieFrames,
      movieSongs,
      movieFrameSeconds: 90,
      displayMode: DISPLAY_SIZES.desktop,
      displayWidth: window.innerWidth,
      activeMovie: movieFrames.lost_in_translation.id,
      longestFilmLength: movieFrames.marie_antoinette.seconds,
      hoverTag: null,
      auth: null,
      song: {
        playing: false,
        data: null,
        mp3: null,
        spotifyData: null
      },

      audioContext: null,
      audioBuffer: null,
      audioSource: null
    };
  },
  methods: {
    setSong(song = null) {
      if (song.uri) {
        let uri = song.uri.split(":")[2];
        fetch(`https://api.spotify.com/v1/tracks/${uri}`, {
          headers: new Headers({
            Authorization: "Bearer " + this.auth
          })
        })
          .then(resp => {
            if (resp.ok) {
              return resp.json();
            }
          })
          .then(resp => {
            this.song.spotifyData = resp;

            if (this.song.spotifyData.preview_url) {
              this.loadMp3(this.song.spotifyData.preview_url);
            }
          });
      } else {
        this.setIsPlaying(false);
      }
      this.song.data = song;
    },
    loadMp3(url) {
      this.deleteSong();
      fetch(url)
        .then(response => response.arrayBuffer())
        .then(arrayBuffer => this.audioContext.decodeAudioData(arrayBuffer))
        .then(audioBuffer => {
          this.audioBuffer = audioBuffer;
          this.loadSong();
          this.setIsPlaying(true);
        });
    },
    loadSong() {
      this.audioSource = this.audioContext.createBufferSource();
      this.audioSource.buffer = this.audioBuffer;
      this.audioSource.connect(this.audioContext.destination);
    },
    playSong() {
      this.audioSource.start();
      this.song.playing = true;
    },
    pauseSong() {
      this.audioSource.stop();
      this.song.playing = false;
    },
    deleteSong() {
      if (!this.audioSource) return;
      this.audioSource.disconnect(this.audioContext.destination);
      this.audioSource.stop();

      this.song.playing = false;
    },
    setIsPlaying(isPlaying) {
      this.song.playing = isPlaying;

      if (isPlaying) {
        this.loadSong();

        this.playSong();
      } else {
        this.pauseSong();
      }
    },
    setActiveMovie(activeMovie) {
      this.activeMovie = activeMovie;
    },
    setSeconds(activeMovie, seconds) {
      this.setActiveMovie(activeMovie);
      this.movieFrameSeconds = seconds;
    },
    setTag(tag = null) {
      this.hoverTag = tag;
    },
    setWidth() {
      this.displayWidth = window.innerWidth;
      if (this.displayWidth < 420) {
        this.displayMode = DISPLAY_SIZES.mobile;
      } else if (this.displayWidth < 768) {
        this.displayMode = DISPLAY_SIZES.tablet;
      } else {
        this.displayMode = DISPLAY_SIZES.desktop;
      }
    }
  },
  mounted() {
    this.setWidth();
    const AudioContext = window.AudioContext || window.webkitAudioContext;

    this.audioContext = new AudioContext();
    window.addEventListener("resize", this.setWidth.bind(this));

    fetch("http://localhost:8009/auth", {
      method: "POST",
      mode: "cors"
    })
      .then(response => {
        if (response.ok) {
          return response.json();
        }
      })
      .then(resp => {
        this.auth = resp.auth;
      });
  },
  beforeDestroy() {
    window.removeEventListener("resize", this.setWidth.bind(this));
  }
};
</script>
<style lang="scss">
@import "../styles/global-styles.scss";

body,
html {
  margin: 0;
  padding: 0;

  font-family: "franklin-gothic-urw", sans-serif;
}

main {
  padding: 16px;
}

#movie-frame--container {
  height: 192px;
  width: 320px;
}

.flex {
  display: flex;
  // align-items: center;
}

.desc-container {
  margin-left: 24px;
  margin-top: 24px;
  
  .desc {
    color: $teal;

    font-style: normal;
    font-weight: 500;
    font-size: 20px;
    line-height: 24px;

    text-shadow: 1px 1px 0px #ffffff;
  }
}

.hint {
  display: flex;

  p {
    /* Scroll through the movies below to hear their soundtrack. */

    font-style: italic;
    font-weight: 300;
    font-size: 18px;
    line-height: 24px;

    color: $hot-pink;
    margin: 0 0 0 8px;
    text-shadow: 1px 1px 0px #ffffff;
    width: 320px;
  }
}

@media only screen and (min-width: 420px) {
  main {
    padding: 24px;
  }
}

@media only screen and (min-width: 768px) {
  main {
    padding: 42px;
  }
}
</style>